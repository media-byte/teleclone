name: Go Build and Test

on:
  push:
    branches:
      - '**'
    tags:
      - '**'
  workflow_dispatch:
    inputs:
      manual:
        description: Manual run (bypass default conditions)
        type: boolean
        required: true
        default: true

jobs:
  build:
    strategy:
      matrix:
        job_name: ['linux_amd64']

        include:
          - job_name: linux_amd64
            os: ubuntu-latest
            go: '1.21'
            goarch: amd64
            gotags: cmount
            build_flags: '-include "^linux/"'

          # - job_name: linux_arm64
          #   os: self-hosted
          #   go: '1.21'
          #   goarch: 'arm64'
          #   gotags: 'cmount'
          #   build_flags: '-include "^linux/"'

    runs-on: ${{ matrix.os }}

    steps:

      - name: Configure Git
        run: |
          git config --global user.email "hackmonker127001@protonmail.com"
          git config --global user.name "hackmonker"

      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: '1.21'

      - name: Set environment variables
        shell: bash
        run: |
            echo "GOTAGS=${{ matrix.gotags }}" >> $GITHUB_ENV
            echo "BUILD_FLAGS=${{ matrix.build_flags }}" >> $GITHUB_ENV
            echo "BUILD_ARGS=${{ matrix.build_args }}" >> $GITHUB_ENV
            echo "GOARCH=${{ matrix.goarch }}" >> $GITHUB_ENV
            echo "CGO_ENABLED=${{ matrix.cgo }}" >> $GITHUB_ENV

            if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            export EXTENSION=".exe"
            else
            export EXTENSION=""
            fi

      - name: Install Libraries on Linux
        shell: bash
        run: |
            sudo modprobe fuse
            sudo chmod 666 /dev/fuse
            sudo chown root:$USER /etc/fuse.conf
            sudo apt-get -y install fuse3 libfuse-dev rpm pkg-config

      - name: Run build
        run: go build .
  
      - name: Rclone version
        shell: bash
        run: |
            ./rclone version
            mkdir /Build
            cp ./rclone /Build/rclone_amd64

  create_tag:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Create Tag
        id: create_tag
        run: |
          NEW_TAG="v20.0-${{ matrix.os }}"
          if ! git tag -l | grep -q "$NEW_TAG"; then
            git tag -a "$NEW_TAG" -m "Release version 20.0 for ${{ matrix.os }}"
            git push origin "$NEW_TAG"
          else
            echo "Tag $NEW_TAG already exists. Skipping tag creation."
          fi
        env:
            GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}